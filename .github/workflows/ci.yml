# ─────────────────────────────────────────────────────────────────────────────
# ci.yml
#
# CI for the ci-workflows repo itself. Validates workflow syntax, shell scripts,
# and documentation references before changes reach main.
#
# This is NOT a reusable workflow — it runs directly on this repo.
# ─────────────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches-ignore: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Workflow syntax validation ─────────────────────────────────────────────
  actionlint:
    name: Lint Workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install actionlint
        run: |
          mkdir -p "$HOME/.local/bin"
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/rhysd/actionlint/releases/latest \
            | jq -r '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .browser_download_url')
          curl -sL "$DOWNLOAD_URL" | tar xz -C "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Run actionlint
        run: actionlint -color -config-file .github/actionlint.yaml

  # ── Shell script linting ───────────────────────────────────────────────────
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run shellcheck on scripts
        run: |
          set -euo pipefail
          EXIT_CODE=0

          # Check inline shell scripts in composite actions
          if [[ -d .github/actions ]]; then
            for action in .github/actions/*/action.yml; do
              if [[ ! -f "$action" ]]; then
                continue
              fi

              echo "Checking $action..."

              # Extract bash run blocks and check them
              # yq extracts run steps, shellcheck validates them
              yq -r '.runs.steps[]? | select(.run != null) | .run' "$action" 2>/dev/null | while read -r script; do
                if [[ -n "$script" ]]; then
                  echo "$script" | shellcheck -s bash - || EXIT_CODE=1
                fi
              done
            done
          fi

          # Check any standalone shell scripts
          shopt -s nullglob
          scripts=(scripts/*.sh)
          if [[ ${#scripts[@]} -gt 0 ]]; then
            shellcheck "${scripts[@]}" || EXIT_CODE=1
          else
            echo "No standalone shell scripts found - skipping"
          fi

          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "✅ Shellcheck passed"
          fi

          exit $EXIT_CODE

  # ── YAML validity ──────────────────────────────────────────────────────────
  yaml-lint:
    name: YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: disable, truthy: disable}}" \
            .github/workflows/*.yml \
            .github/actions/*/action.yml

  # ── Documentation references ───────────────────────────────────────────────
  doc-references:
    name: Check Doc References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify referenced files exist
        run: |
          set -euo pipefail
          EXIT_CODE=0

          echo "Checking file references in documentation..."

          # Files that should exist based on README.md structure section
          EXPECTED_FILES=(
            ".github/workflows/ci.yml"
            ".github/workflows/full-pipeline.yml"
            ".github/workflows/node-ci.yml"
            ".github/workflows/python-ci.yml"
            ".github/workflows/docker-build-push.yml"
            ".github/workflows/deploy-railway.yml"
            ".github/workflows/smoke-test.yml"
            ".github/workflows/integration-test.yml"
            ".github/workflows/unit-test-container.yml"
            ".github/workflows/validate-pipeline.yml"
            ".github/actions/setup-railway/action.yml"
            ".github/actions/health-check/action.yml"
            ".github/actions/notify-slack/action.yml"
            ".github/actions/smoke-test/action.yml"
            "templates/service-repo/.github/workflows/ci.yml"
            "templates/service-repo/.github/workflows/cd.yml"
            "docs/onboarding.md"
            "docs/architecture.md"
            "docs/troubleshooting.md"
            "docs/runbook.md"
            "docs/customization.md"
          )

          for file in "${EXPECTED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing: $file"
              EXIT_CODE=1
            else
              echo "✓ Found: $file"
            fi
          done

          if [[ $EXIT_CODE -eq 0 ]]; then
            echo ""
            echo "✅ All referenced files exist"
          else
            echo ""
            echo "❌ Some referenced files are missing"
          fi

          exit $EXIT_CODE
