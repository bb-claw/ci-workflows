# ─────────────────────────────────────────────────────────────────────────────
# full-pipeline.yml
#
# Top-level CD orchestrator. This is the workflow service repos call.
# Chains build → unit-test → deploy-dev → smoke-test → integration-test
#           → [manual approval] → deploy-prod → smoke-test-prod (rollback on failure)
#
# Usage in a service repo:
#
#   jobs:
#     pipeline:
#       uses: bb-claw/ci-workflows/.github/workflows/full-pipeline.yml@v1
#       with:
#         dev-url: ${{ vars.DEV_URL }}
#         prod-url: ${{ vars.PROD_URL }}
#         railway-service-id-dev: ${{ vars.RAILWAY_SERVICE_ID_DEV }}
#         railway-service-id-prod: ${{ vars.RAILWAY_SERVICE_ID_PROD }}
#       secrets: inherit
# ─────────────────────────────────────────────────────────────────────────────
name: Full CD Pipeline

on:
  workflow_call:
    inputs:
      dev-url:
        description: "Base URL of the dev Railway environment (e.g. https://app-dev.up.railway.app)"
        type: string
        required: true
      prod-url:
        description: "Base URL of the production Railway environment"
        type: string
        required: true
      railway-service-id-dev:
        description: "Railway service ID for the dev environment"
        type: string
        required: true
      railway-service-id-prod:
        description: "Railway service ID for the production environment"
        type: string
        required: true
      railway-project-id-dev:
        description: "Railway project ID for dev (optional, may be required for some tokens)"
        type: string
        required: false
        default: ""
      railway-project-id-prod:
        description: "Railway project ID for prod (optional, may be required for some tokens)"
        type: string
        required: false
        default: ""
      railway-environment-id-dev:
        description: "Railway environment ID for dev (optional, may be required for some tokens)"
        type: string
        required: false
        default: ""
      railway-environment-id-prod:
        description: "Railway environment ID for prod (optional, may be required for some tokens)"
        type: string
        required: false
        default: ""
      dockerfile:
        description: "Path to Dockerfile relative to repo root"
        type: string
        default: "./Dockerfile"
      health-check-path:
        description: "URL path used for smoke tests (default: /health)"
        type: string
        default: "/health"
      integration-test-command:
        description: "Shell command to run integration tests (leave empty for package-manager default)"
        type: string
        default: ""
      unit-test-command:
        description: "Shell command to run unit tests inside the container"
        type: string
        default: "npm test"
      node-version:
        description: "Node.js version for integration test runner"
        type: string
        default: "22"
      package-manager:
        description: "Package manager to use: npm, pnpm, or yarn"
        type: string
        default: "npm"
    secrets:
      RAILWAY_TOKEN_DEV:
        required: true
      RAILWAY_TOKEN_PROD:
        required: true

# ── 0. VALIDATE PIPELINE ────────────────────────────────────────────────────────
jobs:
  validate:
    uses: bb-claw/ci-workflows/.github/workflows/validate-pipeline.yml@v1
    with:
      dev-url: ${{ inputs.dev-url }}
      prod-url: ${{ inputs.prod-url }}
      railway-service-id-dev: ${{ inputs.railway-service-id-dev }}
      railway-service-id-prod: ${{ inputs.railway-service-id-prod }}
      dockerfile: ${{ inputs.dockerfile }}
    secrets:
      RAILWAY_TOKEN_DEV: ${{ secrets.RAILWAY_TOKEN_DEV }}
      RAILWAY_TOKEN_PROD: ${{ secrets.RAILWAY_TOKEN_PROD }}

# ── 1. BUILD & PUSH ──────────────────────────────────────────────────────────
  build:
    needs: validate
    uses: bb-claw/ci-workflows/.github/workflows/docker-build-push.yml@v1
    with:
      dockerfile: ${{ inputs.dockerfile }}
    # Note: permissions are set inside docker-build-push.yml (cannot override in caller)

# ── 2. UNIT TEST (inside built container) ────────────────────────────────────
  unit-test:
    needs: build
    uses: bb-claw/ci-workflows/.github/workflows/unit-test-container.yml@v1
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.digest }}
      test-command: ${{ inputs.unit-test-command }}

# ── 3. DEPLOY DEV ────────────────────────────────────────────────────────────
  deploy-dev:
    needs: [build, unit-test]
    uses: bb-claw/ci-workflows/.github/workflows/deploy-railway.yml@main
    with:
      service-id: ${{ inputs.railway-service-id-dev }}
      project-id: ${{ inputs.railway-project-id-dev }}
      environment-id: ${{ inputs.railway-environment-id-dev }}
      environment: dev
    secrets:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_DEV }}

# ── 4. SMOKE TEST — DEV ──────────────────────────────────────────────────────
  smoke-test-dev:
    needs: deploy-dev
    uses: bb-claw/ci-workflows/.github/workflows/smoke-test.yml@v1
    with:
      url: ${{ inputs.dev-url }}
      health-check-path: ${{ inputs.health-check-path }}

# ── 5. INTEGRATION TESTS — vs DEV ────────────────────────────────────────────
  integration-test:
    needs: smoke-test-dev
    uses: bb-claw/ci-workflows/.github/workflows/integration-test.yml@v1
    with:
      api-base-url: ${{ inputs.dev-url }}
      test-command: ${{ inputs.integration-test-command }}
      node-version: ${{ inputs.node-version }}
      package-manager: ${{ inputs.package-manager }}
    secrets:
      RAILWAY_TOKEN_DEV: ${{ secrets.RAILWAY_TOKEN_DEV }}

# ── 6. APPROVAL — PRODUCTION (manual approval required) ────────────────────
  approval-prod:
    needs: integration-test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - run: echo "Manual approval required before prod deployment"

# ── 7. DEPLOY PRODUCTION (manual approval gate) ──────────────────────────────
  deploy-prod:
    needs: [build, approval-prod]
    uses: bb-claw/ci-workflows/.github/workflows/deploy-railway.yml@main
    with:
      service-id: ${{ inputs.railway-service-id-prod }}
      project-id: ${{ inputs.railway-project-id-prod }}
      environment-id: ${{ inputs.railway-environment-id-prod }}
      environment: production
    secrets:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}

# ── 8. SMOKE TEST — PROD (rollback on failure) ───────────────────────────────
  smoke-test-prod:
    needs: deploy-prod
    uses: bb-claw/ci-workflows/.github/workflows/smoke-test.yml@v1
    with:
      url: ${{ inputs.prod-url }}
      health-check-path: ${{ inputs.health-check-path }}
      rollback-on-failure: true
      service-id: ${{ inputs.railway-service-id-prod }}
    secrets:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
