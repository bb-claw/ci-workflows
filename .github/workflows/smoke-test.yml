# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# smoke-test.yml
#
# HTTP health check against a live environment URL.
# Retries up to `max-retries` times with `retry-interval` seconds between
# attempts to handle Railway cold-start time.
#
# When rollback-on-failure is true (used for the prod smoke test), a failed
# health check triggers `railway rollback` to the previous deployment before
# marking the job as failed.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Smoke Test

on:
  workflow_call:
    inputs:
      url:
        description: "Base URL to test (without trailing slash)"
        type: string
        required: true
      health-check-path:
        description: "Path to check (default: /health)"
        type: string
        default: "/health"
      version-check-path:
        description: "Path to version endpoint (default: /version) - optional for deployment verification"
        type: string
        default: "/version"
      verify-deployment:
        description: "Verify that deployment actually happened (requires version endpoint)"
        type: boolean
        default: false
      max-retries:
        description: "Maximum number of retry attempts"
        type: number
        default: 15
      retry-interval:
        description: "Seconds to wait between retries"
        type: number
        default: 10
      expected-status:
        description: "Expected HTTP status code"
        type: number
        default: 200
      rollback-on-failure:
        description: "Run railway rollback if health check fails (use for prod)"
        type: boolean
        default: false
      service-id:
        description: "Railway service ID â€” required when rollback-on-failure is true"
        type: string
        default: ""
    secrets:
      RAILWAY_TOKEN:
        required: false

jobs:
  smoke-test:
    name: Smoke Test (${{ inputs.url }})
    runs-on: ubuntu-latest

    steps:
      - name: Health check with retry loop
        id: health-check
        run: |
          TARGET="${{ inputs.url }}${{ inputs.health-check-path }}"
          MAX=${{ inputs.max-retries }}
          INTERVAL=${{ inputs.retry-interval }}
          EXPECTED=${{ inputs.expected-status }}

          echo "Checking $TARGET (expected HTTP $EXPECTED)"
          echo "Max retries: $MAX Ã— ${INTERVAL}s = $((MAX * INTERVAL))s timeout"
          echo ""

          for i in $(seq 1 $MAX); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$TARGET" 2>/dev/null || echo "000")

            if [ "$STATUS" = "$EXPECTED" ]; then
              echo "âœ… Attempt $i: HTTP $STATUS â€” healthy"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "â³ Attempt $i/$MAX: HTTP $STATUS â€” retrying in ${INTERVAL}s..."
            sleep $INTERVAL
          done

          echo "âŒ Service not healthy after $MAX attempts (last status: $STATUS)"
          echo "healthy=false" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Check version before deployment (verification only)
        if: ${{ inputs.verify-deployment }}
        id: version-before
        run: |
          URL="${{ inputs.url }}${{ inputs.version-check-path }}"
          echo "Fetching version from $URL"

          VERSION=$(curl -s "$URL" | jq -r '.git_sha_short // "unknown"' 2>/dev/null || echo "unknown")
          echo "Current deployed version: $VERSION"
          echo "version_before=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Check version after deployment (verification only)
        if: ${{ inputs.verify-deployment && steps.health-check.outputs.healthy == 'true' }}
        id: version-after
        run: |
          URL="${{ inputs.url }}${{ inputs.version-check-path }}"
          VERSION=$(curl -s "$URL" | jq -r '.git_sha_short // "unknown"' 2>/dev/null || echo "unknown")
          echo "New deployed version: $VERSION"
          echo "version_after=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify deployment actually happened
        if: ${{ inputs.verify-deployment && steps.health-check.outputs.healthy == 'true' }}
        run: |
          BEFORE="${{ steps.version-before.outputs.version_before }}"
          AFTER="${{ steps.version-after.outputs.version_after }}"

          if [ "$BEFORE" = "$AFTER" ]; then
            echo "âŒ DEPLOYMENT FAILED: Version unchanged ($BEFORE)"
            echo "The service responded but the version did not change."
            echo "This indicates the redeploy command did not actually trigger."
            exit 1
          fi

          echo "âœ… Deployment verified: $BEFORE â†’ $AFTER"

      # Rollback if this is the prod smoke test and it failed
      - name: Install Railway CLI (rollback)
        if: ${{ failure() && inputs.rollback-on-failure }}
        uses: bb-claw/ci-workflows/.github/actions/setup-railway@v1

      - name: Rollback production deployment
        if: ${{ failure() && inputs.rollback-on-failure && inputs.service-id != '' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ”„ Production smoke test failed â€” rolling back to previous deployment..."
          railway rollback \
            --service "${{ inputs.service-id }}" \
            --yes
          echo "âª Rollback triggered"

      - name: Summary
        if: always()
        run: |
          {
            echo "## Smoke Test"
            echo "| | |"
            echo "|---|---|"
            echo "| **URL** | \`${{ inputs.url }}${{ inputs.health-check-path }}\` |"
            echo "| **Result** | ${{ steps.health-check.outputs.healthy == 'true' && 'âœ… Healthy' || 'âŒ Failed' }} |"
            if [[ "${{ inputs.verify-deployment }}" == "true" ]]; then
              echo "| **Before** | \`${{ steps.version-before.outputs.version_before }}\` |"
              echo "| **After** | \`${{ steps.version-after.outputs.version_after }}\` |"
            fi
            if [[ "${{ inputs.rollback-on-failure }}" == "true" && "${{ steps.health-check.outputs.healthy }}" != "true" ]]; then
              echo "| **Action** | âª Rollback triggered |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
