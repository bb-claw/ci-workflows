# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# smoke-test.yml
#
# HTTP health check against a live environment URL.
# Retries up to `max-retries` times with `retry-interval` seconds between
# attempts to handle Railway cold-start time.
#
# When rollback-on-failure is true (used for the prod smoke test), a failed
# health check triggers `railway rollback` to the previous deployment before
# marking the job as failed.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Smoke Test

on:
  workflow_call:
    inputs:
      url:
        description: "Base URL to test (without trailing slash)"
        type: string
        required: true
      health-check-path:
        description: "Path to check (default: /health)"
        type: string
        default: "/health"
      max-retries:
        description: "Maximum number of retry attempts"
        type: number
        default: 15
      retry-interval:
        description: "Seconds to wait between retries"
        type: number
        default: 10
      expected-status:
        description: "Expected HTTP status code"
        type: number
        default: 200
      rollback-on-failure:
        description: "Run railway rollback if health check fails (use for prod)"
        type: boolean
        default: false
      service-id:
        description: "Railway service ID â€” required when rollback-on-failure is true"
        type: string
        default: ""
    secrets:
      RAILWAY_TOKEN:
        required: false

jobs:
  smoke-test:
    name: Smoke Test (${{ inputs.url }})
    runs-on: ubuntu-latest

    steps:
      - name: Health check with retry loop
        id: health-check
        run: |
          TARGET="${{ inputs.url }}${{ inputs.health-check-path }}"
          MAX=${{ inputs.max-retries }}
          INTERVAL=${{ inputs.retry-interval }}
          EXPECTED=${{ inputs.expected-status }}

          echo "Checking $TARGET (expected HTTP $EXPECTED)"
          echo "Max retries: $MAX Ã— ${INTERVAL}s = $((MAX * INTERVAL))s timeout"
          echo ""

          for i in $(seq 1 $MAX); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              --connect-timeout 5 \
              "$TARGET" 2>/dev/null || echo "000")

            if [ "$STATUS" = "$EXPECTED" ]; then
              echo "âœ… Attempt $i: HTTP $STATUS â€” healthy"
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "â³ Attempt $i/$MAX: HTTP $STATUS â€” retrying in ${INTERVAL}s..."
            sleep $INTERVAL
          done

          echo "âŒ Service not healthy after $MAX attempts (last status: $STATUS)"
          echo "healthy=false" >> "$GITHUB_OUTPUT"
          exit 1

      # Rollback if this is the prod smoke test and it failed
      - name: Install Railway CLI (rollback)
        if: ${{ failure() && inputs.rollback-on-failure }}
        uses: bb-claw/ci-workflows/.github/actions/setup-railway@v1

      - name: Rollback production deployment
        if: ${{ failure() && inputs.rollback-on-failure && inputs.service-id != '' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ”„ Production smoke test failed â€” rolling back to previous deployment..."
          railway rollback \
            --service "${{ inputs.service-id }}" \
            --yes
          echo "âª Rollback triggered"

      - name: Summary
        if: always()
        run: |
          echo "## Smoke Test" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **URL** | \`${{ inputs.url }}${{ inputs.health-check-path }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Result** | ${{ steps.health-check.outputs.healthy == 'true' && 'âœ… Healthy' || 'âŒ Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ inputs.rollback-on-failure }}" == "true" && "${{ steps.health-check.outputs.healthy }}" != "true" ]]; then
            echo "| **Action** | âª Rollback triggered |" >> "$GITHUB_STEP_SUMMARY"
          fi
