name: Validate Pipeline Configuration

on:
  workflow_call:
    inputs:
      dev-url:
        description: "Base URL of the dev environment"
        type: string
        required: true
      prod-url:
        description: "Base URL of the production environment"
        type: string
        required: true
      railway-service-id-dev:
        description: "Railway service ID for dev"
        type: string
        required: true
      railway-service-id-prod:
        description: "Railway service ID for production"
        type: string
        required: true
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "./Dockerfile"
    secrets:
      RAILWAY_TOKEN_DEV:
        required: true
      RAILWAY_TOKEN_PROD:
        required: true

jobs:
  validate:
    name: Validate Configuration & Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate variables and secrets
        run: |
          set -e

          echo "üîç Validating required configuration..."
          
          # Validate dev-url
          if [ -z "${{ inputs.dev-url }}" ]; then
            echo "‚ùå Error: dev-url is empty"
            exit 1
          fi
          echo "‚úÖ dev-url: ${{ inputs.dev-url }}"

          # Validate prod-url
          if [ -z "${{ inputs.prod-url }}" ]; then
            echo "‚ùå Error: prod-url is empty"
            exit 1
          fi
          echo "‚úÖ prod-url: ${{ inputs.prod-url }}"

          # Validate railway-service-id-dev
          if [ -z "${{ inputs.railway-service-id-dev }}" ]; then
            echo "‚ùå Error: railway-service-id-dev is empty"
            exit 1
          fi
          echo "‚úÖ railway-service-id-dev: ${{ inputs.railway-service-id-dev }}"

          # Validate railway-service-id-prod
          if [ -z "${{ inputs.railway-service-id-prod }}" ]; then
            echo "‚ùå Error: railway-service-id-prod is empty"
            exit 1
          fi
          echo "‚úÖ railway-service-id-prod: ${{ inputs.railway-service-id-prod }}"

          echo ""
          echo "üîê Validating secrets..."

          # Validate Railway tokens
          if [ -z "${{ secrets.RAILWAY_TOKEN_DEV }}" ]; then
            echo "‚ùå Error: RAILWAY_TOKEN_DEV secret is not set"
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN_DEV is set"

          if [ -z "${{ secrets.RAILWAY_TOKEN_PROD }}" ]; then
            echo "‚ùå Error: RAILWAY_TOKEN_PROD secret is not set"
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN_PROD is set"

      - name: Validate Dockerfile
        run: |
          if [ ! -f "${{ inputs.dockerfile }}" ]; then
            echo "‚ùå Error: Dockerfile not found at ${{ inputs.dockerfile }}"
            exit 1
          fi
          echo "‚úÖ Dockerfile exists: ${{ inputs.dockerfile }}"

      - name: Test URLs
        continue-on-error: true
        run: |
          echo "üåê Testing URL accessibility..."
          if curl -sf --connect-timeout 5 "${{ inputs.dev-url }}/health" > /dev/null 2>&1; then
            echo "‚úÖ dev-url is accessible"
          else
            echo "‚ö†Ô∏è  dev-url not responding yet (may be starting)"
          fi

          if curl -sf --connect-timeout 5 "${{ inputs.prod-url }}/health" > /dev/null 2>&1; then
            echo "‚úÖ prod-url is accessible"
          else
            echo "‚ö†Ô∏è  prod-url not responding yet (may be starting)"
          fi

      - name: Validation Summary
        if: success()
        run: |
          echo ""
          echo "‚úÖ Pipeline validation passed!"
          echo "Ready to proceed with build and deployment."
          echo ""
