name: Validate Pipeline Configuration

on:
  workflow_call:
    inputs:
      dev-url:
        description: "Base URL of the dev environment"
        type: string
        required: true
      prod-url:
        description: "Base URL of the production environment"
        type: string
        required: true
      railway-service-id-dev:
        description: "Railway service ID for dev"
        type: string
        required: true
      railway-service-id-prod:
        description: "Railway service ID for production"
        type: string
        required: true
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "./Dockerfile"
    secrets:
      RAILWAY_TOKEN_DEV:
        required: true
      RAILWAY_TOKEN_PROD:
        required: true

jobs:
  validate:
    name: Validate Configuration & Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required variables
        run: |
          set -e
          echo "ğŸ” Validating required configuration..."
          
          # Check dev environment
          if [ -z "$DEV_URL" ]; then
            echo "âŒ Error: dev-url is empty"
            exit 1
          fi
          echo "âœ… dev-url: $DEV_URL"
          
          # Check prod environment
          if [ -z "$PROD_URL" ]; then
            echo "âŒ Error: prod-url is empty"
            exit 1
          fi
          echo "âœ… prod-url: $PROD_URL"
          
          # Check dev service ID
          if [ -z "$RAILWAY_SERVICE_ID_DEV" ]; then
            echo "âŒ Error: railway-service-id-dev is empty"
            exit 1
          fi
          echo "âœ… railway-service-id-dev: $RAILWAY_SERVICE_ID_DEV"
          
          # Check prod service ID
          if [ -z "$RAILWAY_SERVICE_ID_PROD" ]; then
            echo "âŒ Error: railway-service-id-prod is empty"
            exit 1
          fi
          echo "âœ… railway-service-id-prod: $RAILWAY_SERVICE_ID_PROD"
        env:
          DEV_URL: ${{ inputs.dev-url }}
          PROD_URL: ${{ inputs.prod-url }}
          RAILWAY_SERVICE_ID_DEV: ${{ inputs.railway-service-id-dev }}
          RAILWAY_SERVICE_ID_PROD: ${{ inputs.railway-service-id-prod }}

      - name: Validate secrets are set
        run: |
          set -e
          echo "ğŸ” Validating secrets..."
          
          if [ -z "$RAILWAY_TOKEN_DEV" ]; then
            echo "âŒ Error: RAILWAY_TOKEN_DEV secret is not set"
            exit 1
          fi
          echo "âœ… RAILWAY_TOKEN_DEV is set"
          
          if [ -z "$RAILWAY_TOKEN_PROD" ]; then
            echo "âŒ Error: RAILWAY_TOKEN_PROD secret is not set"
            exit 1
          fi
          echo "âœ… RAILWAY_TOKEN_PROD is set"
        env:
          RAILWAY_TOKEN_DEV: ${{ secrets.RAILWAY_TOKEN_DEV }}
          RAILWAY_TOKEN_PROD: ${{ secrets.RAILWAY_TOKEN_PROD }}

      - name: Validate URLs are accessible
        run: |
          echo "ğŸŒ Testing URL accessibility..."
          
          # Test dev URL
          if curl -sf --connect-timeout 5 "$DEV_URL/health" > /dev/null 2>&1; then
            echo "âœ… dev-url is accessible: $DEV_URL"
          else
            echo "âš ï¸  dev-url not responding yet (may be starting): $DEV_URL"
          fi
          
          # Test prod URL
          if curl -sf --connect-timeout 5 "$PROD_URL/health" > /dev/null 2>&1; then
            echo "âœ… prod-url is accessible: $PROD_URL"
          else
            echo "âš ï¸  prod-url not responding yet (may be starting): $PROD_URL"
          fi
        env:
          DEV_URL: ${{ inputs.dev-url }}
          PROD_URL: ${{ inputs.prod-url }}
        continue-on-error: true

      - name: Validate Dockerfile exists
        run: |
          echo "ğŸ“¦ Validating Dockerfile..."
          
          if [ ! -f "$DOCKERFILE" ]; then
            echo "âŒ Error: Dockerfile not found at $DOCKERFILE"
            exit 1
          fi
          echo "âœ… Dockerfile exists: $DOCKERFILE"
          
          # Basic syntax check
          if docker run --rm -i hadolint/hadolint < "$DOCKERFILE"; then
            echo "âœ… Dockerfile syntax is valid"
          else
            echo "âš ï¸  Dockerfile has some warnings (continuing anyway)"
          fi
        env:
          DOCKERFILE: ${{ inputs.dockerfile }}
        continue-on-error: true

      - name: Validate workflow files
        run: |
          echo "ğŸ”§ Validating workflow YAML syntax..."
          
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            if docker run --rm -v "$PWD:$PWD" -w "$PWD" mikefarah/yq eval "$file" > /dev/null 2>&1; then
              echo "âœ… Valid: $file"
            else
              echo "âŒ Invalid YAML: $file"
              exit 1
            fi
          done
        continue-on-error: true

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Pipeline Validation Successful!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Configuration Summary:"
          echo "  Dev Environment:  ${{ inputs.dev-url }}"
          echo "  Prod Environment: ${{ inputs.prod-url }}"
          echo "  Dev Service ID:   ${{ inputs.railway-service-id-dev }}"
          echo "  Prod Service ID:  ${{ inputs.railway-service-id-prod }}"
          echo "  Dockerfile:       ${{ inputs.dockerfile }}"
          echo ""
          echo "Ready to proceed with build and deployment!"
          echo ""

      - name: Failure Summary
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Pipeline Validation Failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Issues found:"
          echo "- Check all required variables are set"
          echo "- Check all secrets are configured"
          echo "- Verify Dockerfile path is correct"
          echo "- Review workflow YAML syntax"
          echo ""
          exit 1
