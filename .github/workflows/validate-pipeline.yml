name: Validate Pipeline Configuration

on:
  workflow_call:
    inputs:
      dev-url:
        description: "Base URL of the dev environment"
        type: string
        required: true
      prod-url:
        description: "Base URL of the production environment"
        type: string
        required: true
      railway-service-id-dev:
        description: "Railway service ID for dev"
        type: string
        required: true
      railway-service-id-prod:
        description: "Railway service ID for production"
        type: string
        required: true
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "./Dockerfile"
    secrets:
      RAILWAY_TOKEN_DEV:
        required: true
      RAILWAY_TOKEN_PROD:
        required: true

jobs:
  validate:
    name: Validate Configuration & Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          DEV_URL="${{ inputs.dev-url }}"
          PROD_URL="${{ inputs.prod-url }}"
          RAILWAY_SERVICE_ID_DEV="${{ inputs.railway-service-id-dev }}"
          RAILWAY_SERVICE_ID_PROD="${{ inputs.railway-service-id-prod }}"
          DOCKERFILE="${{ inputs.dockerfile }}"
          RAILWAY_TOKEN_DEV="${{ secrets.RAILWAY_TOKEN_DEV }}"
          RAILWAY_TOKEN_PROD="${{ secrets.RAILWAY_TOKEN_PROD }}"

          FAILED=0

          # Validate URLs
          if [ -z "$DEV_URL" ]; then
            echo "❌ dev-url is empty"
            FAILED=1
          else
            echo "✅ dev-url: $DEV_URL"
          fi

          if [ -z "$PROD_URL" ]; then
            echo "❌ prod-url is empty"
            FAILED=1
          else
            echo "✅ prod-url: $PROD_URL"
          fi

          # Validate service IDs
          if [ -z "$RAILWAY_SERVICE_ID_DEV" ]; then
            echo "❌ railway-service-id-dev is empty"
            FAILED=1
          else
            echo "✅ railway-service-id-dev: $RAILWAY_SERVICE_ID_DEV"
          fi

          if [ -z "$RAILWAY_SERVICE_ID_PROD" ]; then
            echo "❌ railway-service-id-prod is empty"
            FAILED=1
          else
            echo "✅ railway-service-id-prod: $RAILWAY_SERVICE_ID_PROD"
          fi

          # Validate tokens
          if [ -z "$RAILWAY_TOKEN_DEV" ]; then
            echo "❌ RAILWAY_TOKEN_DEV secret is not set"
            FAILED=1
          else
            echo "✅ RAILWAY_TOKEN_DEV is set"
          fi

          if [ -z "$RAILWAY_TOKEN_PROD" ]; then
            echo "❌ RAILWAY_TOKEN_PROD secret is not set"
            FAILED=1
          else
            echo "✅ RAILWAY_TOKEN_PROD is set"
          fi

          # Validate Dockerfile
          if [ ! -f "$DOCKERFILE" ]; then
            echo "❌ Dockerfile not found at $DOCKERFILE"
            FAILED=1
          else
            echo "✅ Dockerfile exists: $DOCKERFILE"
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "❌ Validation failed"
            exit 1
          fi

          echo ""
          echo "✅ All validations passed"

      - name: Test URLs (best effort)
        continue-on-error: true
        run: |
          DEV_URL="${{ inputs.dev-url }}"
          PROD_URL="${{ inputs.prod-url }}"

          if curl -sf --connect-timeout 5 "$DEV_URL/health" > /dev/null 2>&1; then
            echo "✅ dev-url is responding"
          else
            echo "⚠️  dev-url not responding yet (may be starting)"
          fi

          if curl -sf --connect-timeout 5 "$PROD_URL/health" > /dev/null 2>&1; then
            echo "✅ prod-url is responding"
          else
            echo "⚠️  prod-url not responding yet (may be starting)"
          fi
