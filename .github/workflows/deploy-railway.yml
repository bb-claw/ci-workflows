# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deploy-railway.yml
#
# Triggers a Railway service redeployment. Railway pulls the latest image
# from ghcr.io (the same digest built by docker-build-push.yml).
#
# Prerequisites:
#   - Railway service must be configured to use a Docker image source
#     pointing to ghcr.io/bb-claw/<service-name>
#   - RAILWAY_TOKEN secret must be scoped to the correct project + environment
#
# Inputs:
#   service-id    â€” Railway service ID (from Railway dashboard â†’ service settings)
#   environment   â€” GitHub environment name ("dev" or "production")
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Deploy to Railway

on:
  workflow_call:
    inputs:
      service-id:
        description: "Railway service ID"
        type: string
        required: true
      project-id:
        description: "Railway project ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment-id:
        description: "Railway environment ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment:
        description: "GitHub environment name (dev | production)"
        type: string
        required: true
    secrets:
      RAILWAY_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy â†’ Railway (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Install Railway CLI
        uses: bb-claw/ci-workflows/.github/actions/setup-railway@v1

      - name: Debug Railway Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ” Debugging Railway connection..."
          echo ""
          echo "1ï¸âƒ£ Checking token validity..."
          railway whoami || echo "âš ï¸ whoami failed"
          echo ""
          echo "2ï¸âƒ£ Listing available services..."
          railway service list || echo "âš ï¸ service list failed"
          echo ""
          echo "3ï¸âƒ£ Service ID to deploy: ${{ inputs.service-id }}"
          echo "4ï¸âƒ£ Project ID: ${{ inputs.project-id || '(not provided)' }}"
          echo "5ï¸âƒ£ Environment ID: ${{ inputs.environment-id || '(not provided)' }}"

      - name: Trigger redeployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸš€ Triggering redeployment for service: ${{ inputs.service-id }}"

          # Build redeploy command
          CMD="railway redeploy --service '${{ inputs.service-id }}' --yes"

          # Add project ID if provided
          if [[ -n "${{ inputs.project-id }}" ]]; then
            CMD="$CMD --project '${{ inputs.project-id }}'"
            echo "  Using project: ${{ inputs.project-id }}"
          fi

          # Add environment ID if provided
          if [[ -n "${{ inputs.environment-id }}" ]]; then
            CMD="$CMD --environment '${{ inputs.environment-id }}'"
            echo "  Using environment: ${{ inputs.environment-id }}"
          fi

          # Try redeploy
          eval "$CMD" || {
            echo ""
            echo "âŒ Redeploy failed. Trying alternative approach..."
            echo ""
            echo "Checking if service exists:"
            railway service list --json | jq '.[] | select(.id == "${{ inputs.service-id }}")'
          }

      - name: Summary
        run: |
          {
            echo "## Railway Deployment"
            echo "| | |"
            echo "|---|---|"
            echo "| **Environment** | \`${{ inputs.environment }}\` |"
            echo "| **Service ID** | \`${{ inputs.service-id }}\` |"
            if [[ -n "${{ inputs.project-id }}" ]]; then
              echo "| **Project ID** | \`${{ inputs.project-id }}\` |"
            fi
            if [[ -n "${{ inputs.environment-id }}" ]]; then
              echo "| **Environment ID** | \`${{ inputs.environment-id }}\` |"
            fi
            echo "| **Status** | âœ… Redeployment triggered |"
          } >> "$GITHUB_STEP_SUMMARY"
