# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deploy-railway.yml
#
# Triggers a Railway service redeployment. Railway pulls the latest image
# from ghcr.io (the same digest built by docker-build-push.yml).
#
# Prerequisites:
#   - Railway service must be configured to use a Docker image source
#     pointing to ghcr.io/bb-claw/<service-name>
#   - RAILWAY_TOKEN secret must be scoped to the correct project + environment
#
# Inputs:
#   service-id    â€” Railway service ID (from Railway dashboard â†’ service settings)
#   environment   â€” GitHub environment name ("dev" or "production")
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Deploy to Railway

on:
  workflow_call:
    inputs:
      service-id:
        description: "Railway service ID"
        type: string
        required: true
      project-id:
        description: "Railway project ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment-id:
        description: "Railway environment ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment:
        description: "GitHub environment name (dev | production)"
        type: string
        required: true
    secrets:
      RAILWAY_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy â†’ Railway (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Install Railway CLI
        uses: bb-claw/ci-workflows/.github/actions/setup-railway@v1

      - name: Debug Railway Connection
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ” Debugging Railway connection..."
          echo ""
          echo "1ï¸âƒ£ Checking token validity..."
          railway whoami || echo "âš ï¸ whoami failed"
          echo ""
          echo "2ï¸âƒ£ Listing available services..."
          railway service list || echo "âš ï¸ service list failed"
          echo ""
          echo "3ï¸âƒ£ Service ID to deploy: ${{ inputs.service-id }}"
          echo "4ï¸âƒ£ Project ID: ${{ inputs.project-id || '(not provided)' }}"
          echo "5ï¸âƒ£ Environment ID: ${{ inputs.environment-id || '(not provided)' }}"

      - name: Trigger redeployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -e

          echo "ðŸš€ Triggering redeployment for service: ${{ inputs.service-id }}"
          echo ""

          SERVICE_ID="${{ inputs.service-id }}"
          PROJECT_ID="${{ inputs.project-id }}"
          ENVIRONMENT_ID="${{ inputs.environment-id }}"

          # Build redeploy command with global flags
          CMD="railway redeploy --service \"$SERVICE_ID\" --yes"

          # Add project ID if provided
          if [[ -n "$PROJECT_ID" ]]; then
            echo "ðŸ“ Using project: $PROJECT_ID"
            CMD="$CMD --project \"$PROJECT_ID\""
          fi

          # Add environment ID if provided
          if [[ -n "$ENVIRONMENT_ID" ]]; then
            echo "ðŸ“ Using environment: $ENVIRONMENT_ID"
            CMD="$CMD --environment \"$ENVIRONMENT_ID\""
          fi

          # Execute redeploy with constructed command
          echo "â–¶ï¸ Executing: $CMD"
          eval "$CMD" || {
            echo ""
            echo "âŒ Redeploy command failed"
            echo ""
            echo "Debugging: Checking if service exists..."
            railway service list --json | jq '.[] | select(.id == "'$SERVICE_ID'")'
            exit 1
          }

          echo ""
          echo "âœ… Redeploy command executed successfully"

      - name: Wait for deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "â³ Waiting for deployment to start..."

          SERVICE_ID="${{ inputs.service-id }}"
          MAX_WAIT=30
          POLL_INTERVAL=2

          for i in $(seq 1 $((MAX_WAIT / POLL_INTERVAL))); do
            STATUS=$(railway service list --json 2>/dev/null | \
              jq -r ".[] | select(.id == \"$SERVICE_ID\") | .status" 2>/dev/null || echo "unknown")

            echo "[$i/$((MAX_WAIT / POLL_INTERVAL))] Status: $STATUS"

            if [[ "$STATUS" == "BUILDING" || "$STATUS" == "DEPLOYING" || "$STATUS" == "CRASHED" ]]; then
              echo "âœ… Deployment detected â€” service is $STATUS"
              exit 0
            fi

            sleep $POLL_INTERVAL
          done

          echo "âš ï¸ Could not detect deployment status (may be queued)"

      - name: Summary
        run: |
          {
            echo "## Railway Deployment"
            echo "| | |"
            echo "|---|---|"
            echo "| **Environment** | \`${{ inputs.environment }}\` |"
            echo "| **Service ID** | \`${{ inputs.service-id }}\` |"
            if [[ -n "${{ inputs.project-id }}" ]]; then
              echo "| **Project ID** | \`${{ inputs.project-id }}\` |"
            fi
            if [[ -n "${{ inputs.environment-id }}" ]]; then
              echo "| **Environment ID** | \`${{ inputs.environment-id }}\` |"
            fi
            echo "| **Status** | âœ… Redeployment triggered |"
          } >> "$GITHUB_STEP_SUMMARY"
