# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deploy-railway.yml
#
# Triggers a Railway service redeployment. Railway pulls the latest image
# from ghcr.io (the same digest built by docker-build-push.yml).
#
# Prerequisites:
#   - Railway service must be configured to use a Docker image source
#     pointing to ghcr.io/bb-claw/<service-name>
#   - RAILWAY_TOKEN secret must be scoped to the correct project + environment
#
# Inputs:
#   service-id    â€” Railway service ID (from Railway dashboard â†’ service settings)
#   environment   â€” GitHub environment name ("dev" or "production")
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Deploy to Railway

on:
  workflow_call:
    inputs:
      service-id:
        description: "Railway service ID"
        type: string
        required: true
      project-id:
        description: "Railway project ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment-id:
        description: "Railway environment ID (optional, may be required for some tokens)"
        type: string
        required: false
      environment:
        description: "GitHub environment name (dev | production)"
        type: string
        required: true
    secrets:
      RAILWAY_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy â†’ Railway (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Install Railway CLI
        uses: bb-claw/ci-workflows/.github/actions/setup-railway@v1

      - name: Validate Railway Token & Service Access
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -e
          
          SERVICE_ID="${{ inputs.service-id }}"
          
          echo "ðŸ” Validating Railway token and service access..."
          echo ""
          
          # Step 1: Verify token is valid
          echo "1ï¸âƒ£ Checking token validity with 'railway whoami'..."
          if ! WHOAMI_OUTPUT=$(railway whoami 2>&1); then
            echo "âŒ TOKEN INVALID: railway whoami failed"
            echo "Error: $WHOAMI_OUTPUT"
            echo ""
            echo "âš ï¸ RAILWAY_TOKEN is either:"
            echo "  - Expired (regenerate in Railway dashboard)"
            echo "  - Invalid format"
            echo "  - Missing from GitHub Secrets"
            exit 1
          fi
          echo "âœ… Token is valid"
          echo "User: $WHOAMI_OUTPUT"
          echo ""
          
          # Step 2: List available services
          echo "2ï¸âƒ£ Listing available services..."
          if ! SERVICE_LIST=$(railway service list --json 2>&1); then
            echo "âŒ SERVICE LIST FAILED: Cannot list services"
            echo "Error: $SERVICE_LIST"
            exit 1
          fi
          echo "âœ… Services found"
          echo ""
          
          # Step 3: Check if target service exists
          echo "3ï¸âƒ£ Checking if service $SERVICE_ID exists..."
          if echo "$SERVICE_LIST" | jq -e ".[] | select(.id == \"$SERVICE_ID\")" > /dev/null 2>&1; then
            echo "âœ… Service found and accessible"
            SERVICE_INFO=$(echo "$SERVICE_LIST" | jq ".[] | select(.id == \"$SERVICE_ID\")")
            echo "Service info:"
            echo "$SERVICE_INFO" | jq '.'
          else
            echo "âŒ SERVICE NOT FOUND OR NOT ACCESSIBLE"
            echo "Service ID: $SERVICE_ID"
            echo "Available services:"
            echo "$SERVICE_LIST" | jq '.[] | {id: .id, name: .name, status: .status}'
            echo ""
            echo "âš ï¸ POSSIBLE CAUSES:"
            echo "  - Service ID is wrong"
            echo "  - Token doesn't have access to this service"
            echo "  - Service exists in different project/environment"
            exit 1
          fi
          echo ""
          
          # Step 4: Show context
          echo "4ï¸âƒ£ Deployment context:"
          echo "  Service ID: $SERVICE_ID"
          [[ -n "${{ inputs.project-id }}" ]] && echo "  Project ID: ${{ inputs.project-id }}"
          [[ -n "${{ inputs.environment-id }}" ]] && echo "  Environment ID: ${{ inputs.environment-id }}"
          echo ""
          echo "âœ… All validation checks passed. Ready to redeploy."

      - name: Trigger redeployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -e

          echo "ðŸš€ Triggering redeployment for service: ${{ inputs.service-id }}"
          echo ""

          SERVICE_ID="${{ inputs.service-id }}"

          # Debug: Show context (project/environment IDs provided, but not used in redeploy command)
          if [[ -n "${{ inputs.project-id }}" ]]; then
            echo "ðŸ“ Project ID provided (context): ${{ inputs.project-id }}"
          fi
          if [[ -n "${{ inputs.environment-id }}" ]]; then
            echo "ðŸ“ Environment ID provided (context): ${{ inputs.environment-id }}"
          fi

          # Execute redeploy with only supported flags
          # Note: railway redeploy only accepts --service and --yes
          # Project/environment context is handled by RAILWAY_TOKEN scope
          echo "â–¶ï¸ Executing: railway redeploy --service \"$SERVICE_ID\" --yes"
          if ! REDEPLOY_OUTPUT=$(railway redeploy --service "$SERVICE_ID" --yes 2>&1); then
            echo ""
            echo "âŒ Redeploy command failed"
            echo "Error output:"
            echo "$REDEPLOY_OUTPUT"
            echo ""
            echo "âš ï¸ COMMON CAUSES:"
            if echo "$REDEPLOY_OUTPUT" | grep -q "Invalid RAILWAY_TOKEN"; then
              echo "  - RAILWAY_TOKEN is invalid or expired"
              echo "  - Token doesn't have access to this project/environment"
              echo "  - Action: Regenerate token in Railway dashboard"
            elif echo "$REDEPLOY_OUTPUT" | grep -q "not found"; then
              echo "  - Service ID is incorrect"
              echo "  - Service doesn't exist in this project/environment"
            else
              echo "  - Unknown error (see output above)"
            fi
            exit 1
          fi
          echo ""
          echo "Redeploy output:"
          echo "$REDEPLOY_OUTPUT"

          echo ""
          echo "âœ… Redeploy command executed successfully"

      - name: Wait for deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "â³ Waiting for deployment to start..."

          SERVICE_ID="${{ inputs.service-id }}"
          MAX_WAIT=30
          POLL_INTERVAL=2

          for i in $(seq 1 $((MAX_WAIT / POLL_INTERVAL))); do
            STATUS=$(railway service list --json 2>/dev/null | \
              jq -r ".[] | select(.id == \"$SERVICE_ID\") | .status" 2>/dev/null || echo "unknown")

            echo "[$i/$((MAX_WAIT / POLL_INTERVAL))] Status: $STATUS"

            if [[ "$STATUS" == "BUILDING" || "$STATUS" == "DEPLOYING" || "$STATUS" == "CRASHED" ]]; then
              echo "âœ… Deployment detected â€” service is $STATUS"
              exit 0
            fi

            sleep $POLL_INTERVAL
          done

          echo "âš ï¸ Could not detect deployment status (may be queued)"

      - name: Summary
        run: |
          {
            echo "## Railway Deployment"
            echo "| | |"
            echo "|---|---|"
            echo "| **Environment** | \`${{ inputs.environment }}\` |"
            echo "| **Service ID** | \`${{ inputs.service-id }}\` |"
            if [[ -n "${{ inputs.project-id }}" ]]; then
              echo "| **Project ID** | \`${{ inputs.project-id }}\` |"
            fi
            if [[ -n "${{ inputs.environment-id }}" ]]; then
              echo "| **Environment ID** | \`${{ inputs.environment-id }}\` |"
            fi
            echo "| **Status** | âœ… Redeployment triggered |"
          } >> "$GITHUB_STEP_SUMMARY"
